name: Build Windows EXE (PyInstaller, Python 3.8, x86/x64)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86, x64]
    env:
      PY_VER: '3.8'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PY_VER }} (${{ matrix.arch }})
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}
          architecture: ${{ matrix.arch }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          # 如需其它依赖，在此追加：pip install -r requirements.txt

      - name: Prepare ffmpeg binaries (x64)
        if: matrix.arch == 'x64'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          choco install ffmpeg -y
          New-Item -ItemType Directory -Force -Path ffmpeg\bin | Out-Null
          $ff = Get-Command ffmpeg.exe | Select-Object -First 1
          $fp = Get-Command ffprobe.exe | Select-Object -First 1
          if (-not $ff -or -not $fp) { throw '未找到 ffmpeg/ffprobe（x64）' }
          Copy-Item $ff.Source -Destination ffmpeg\bin\ffmpeg.exe -Force
          Copy-Item $fp.Source -Destination ffmpeg\bin\ffprobe.exe -Force
          Write-Host "Copied:" (Get-Item ffmpeg\bin\ffmpeg.exe).FullName
          Write-Host "Copied:" (Get-Item ffmpeg\bin\ffprobe.exe).FullName

      - name: Prepare ffmpeg binaries (x86)
        if: matrix.arch == 'x86'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          choco install ffmpeg -y --x86
          New-Item -ItemType Directory -Force -Path ffmpeg\bin | Out-Null
          $ff = Get-Command ffmpeg.exe | Select-Object -First 1
          $fp = Get-Command ffprobe.exe | Select-Object -First 1
          if (-not $ff -or -not $fp) { throw '未找到 ffmpeg/ffprobe（x86）' }
          Copy-Item $ff.Source -Destination ffmpeg\bin\ffmpeg.exe -Force
          Copy-Item $fp.Source -Destination ffmpeg\bin\ffprobe.exe -Force
          Write-Host "Copied:" (Get-Item ffmpeg\bin\ffmpeg.exe).FullName
          Write-Host "Copied:" (Get-Item ffmpeg\bin\ffprobe.exe).FullName

      - name: Build EXE with PyInstaller
        shell: pwsh
        run: |
          pyinstaller --onefile `
            --name BiliMusic-${{ matrix.arch }}-py${{ env.PY_VER }} `
            --runtime-hook hooks\rthook_meipass_path.py `
            --add-binary "ffmpeg\bin\ffmpeg.exe;." `
            --add-binary "ffmpeg\bin\ffprobe.exe;." `
            2.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BiliMusic-${{ matrix.arch }}-py${{ env.PY_VER }}
          path: |
            dist\BiliMusic-${{ matrix.arch }}-py${{ env.PY_VER }}.exe
            BiliMusic.spec
